<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      dialog {
        margin: auto;
      }

      .dialog-wrapper {
        padding: 30px;
        padding-top: 40px;
        position: relative;
      }

      .dialog-close {
        position: absolute;
        top: 10px;
        right: 10px;
      }

      .page {
        padding: 0 20px;
      }

      h1 {
        margin-bottom: 20px;
      }

      .actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .action {
        padding: 10px;
      }

      .tags-block {
        margin-bottom: 20px;
      }

      .tags-block h2 {
        margin-bottom: 20px;
      }

      .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .tag {
        display: flex;
        gap: 10px;
        border: 1px solid lightgrey;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.15);
        padding: 10px;
        border-radius: 5px;
      }

      .items-block h2 {
        margin-bottom: 20px;
      }

      .items-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .item {
        border: 1px solid lightgrey;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.15);
        padding: 10px;
        border-radius: 5px;
      }

      .item-wrapper {
        display: flex;
        gap: 10px;
      }

      .item-content {
        flex-grow: 1;
      }

      .item-actions {
        flex-shrink: 0;
      }

      .item-name {
        font-weight: bold;
      }

      .item-tag {
        display: inline-block;
        border-radius: 4px;
        padding: 5px;
        border: 1px solid lightgray;
      }

      .item-subitems-wrapper {
        padding-left: 20px;
        display: flex;
        flex-direction: column-reverse;
      }

      .item-subitems-title {
        font-weight: bold;
        margin-top: 10px;
      }

      .item-subitems:not(:empty) {
        padding: 10px 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .item-subitems:empty + .item-subitems-title {
        display: none;
      }

      .subitem-tag {
        display: inline-block;
        border-radius: 4px;
        padding: 5px;
        border: 1px solid lightgray;
      }
    </style>
  </head>
  <body>
    <template id="item-tmpl">
      <div class="item">
        <div class="item-wrapper">
          <div class="item-content">
            <div class="item-text"></div>
            <div class="item-price"></div>
            <div class="item-tag"></div>

            <div class="item-subitems-wrapper">
              <div class="item-subitems"></div>
              <div class="item-subitems-title">Подтраты</div>
            </div>
          </div>
          <div class="item-actions">
            <button class="item-remove">&times;</button>
          </div>
        </div>
      </div>
    </template>

    <template id="tag-tmpl">
      <div class="tag">
        <div class="tag-name"></div>

        <button class="tag-remove">&times;</button>
      </div>
    </template>

    <template id="subitem-tmpl">
      <div class="subitem">
        <div class="subitem-text"></div>
        <div class="subitem-price"></div>
        <div class="subitem-tag"></div>
      </div>
    </template>

    <template id="subitem-form-tmpl">
      <div class="subitem-form">
        <input type="text" name="subitems[text][]" />
        <input type="number" name="subitems[price][]" />
        <select name="subitems[tag][]"></select>
      </div>
    </template>

    <dialog id="new-item-dialog">
      <div class="dialog-wrapper">
        <button class="dialog-close" id="close-new-item-dialog" type="button">
          &times;
        </button>
        <form id="new-item-form">
          <input type="text" name="text" placeholder="text" />
          <input type="number" name="price" placeholder="price" />
          <select name="tag" id="tags-select"></select>

          <div id="new-item-form-subitems"></div>

          <button type="button" id="new-item-add-subitem">
            Добавить подтрату
          </button>

          <br />
          <button type="submit">Сохранить</button>
        </form>
      </div>
    </dialog>

    <dialog id="new-tag-dialog">
      <div class="dialog-wrapper">
        <button class="dialog-close" id="close-new-tag-dialog" type="button">
          &times;
        </button>
        <form id="new-tag-form">
          <input type="text" name="name" placeholder="name" />
          <button type="submit">Сохранить</button>
        </form>
      </div>
    </dialog>

    <div class="page">
      <h1>Все траты</h1>

      <div class="actions">
        <button class="action" id="add-item" type="button">
          Добавить трату
        </button>
        <button class="action" id="add-tag" type="button">Добавить тег</button>
      </div>

      <div class="tags-block">
        <h2>Теги</h2>
        <div class="tags-list" id="tags"></div>
      </div>

      <div class="items-block">
        <h2>Траты</h2>
        <div id="items" class="items-list"></div>
      </div>
    </div>

    <script>
      // Constants
      const DB_NAME = "wallet";
      const DB_VERSION = 2;
      const ITEMS_STORE_NAME = "items";
      const TAGS_STORE_NAME = "tags";

      let items = [];
      let tags = [];

      let lastItemId = 0;
      let lastTagId = 0;

      // Elements
      const $itemsList = document.getElementById("items");
      const $itemTemplate = document.getElementById("item-tmpl");
      const $newItemDialog = document.getElementById("new-item-dialog");
      const $newItemForm = document.getElementById("new-item-form");
      const $addItemBtn = document.getElementById("add-item");
      const $closeNewItemDialogBtn = document.getElementById(
        "close-new-item-dialog"
      );
      const $tagsList = document.getElementById("tags");
      const $tagTemplate = document.getElementById("tag-tmpl");
      const $newTagDialog = document.getElementById("new-tag-dialog");
      const $newTagForm = document.getElementById("new-tag-form");
      const $addTagBtn = document.getElementById("add-tag");
      const $closeNewTagDialogBtn = document.getElementById(
        "close-new-tag-dialog"
      );
      const $tagsSelect = document.getElementById("tags-select");
      const $newItemFormSubitemsList = document.getElementById(
        "new-item-form-subitems"
      );
      const $newItemAddSubitemBtn = document.getElementById(
        "new-item-add-subitem"
      );
      const $subitemFormTemplate = document.getElementById("subitem-form-tmpl");
      const $subitemTemplate = document.getElementById("subitem-tmpl");

      // Render
      function renderItem(item) {
        const $clone = $itemTemplate.content.cloneNode(true);
        const $item = $clone.querySelector(".item");
        $item.querySelector(".item-text").textContent = item.text;
        $item.querySelector(".item-price").textContent = item.price;
        const itemTag = tags.find((tag) => tag.id === item.tag);
        $item.querySelector(".item-tag").textContent = itemTag?.name || "";
        $item.querySelector(".item-remove").onclick = () => {
          items = items.filter((i) => i.id !== item.id);
          removeItemFromDb(item);
          $item.remove();
        };
        if (item.subitems?.length > 0) {
          const $subitemsList = $item.querySelector(".item-subitems");
          item.subitems.forEach((subitem) => {
            const $subitem = renderSubitem(subitem);
            $subitemsList.appendChild($subitem);
          });
        }

        return $item;
      }
      function renderItems() {
        items.forEach((item) => {
          const $item = renderItem(item);
          $itemsList.appendChild($item);
        });
      }
      function renderSubitemForm() {
        const $clone = $subitemFormTemplate.content.cloneNode(true);
        const $subitem = $clone.querySelector(".subitem-form");
        const $subitemSelect = $subitem.querySelector("select");
        tags.forEach((tag) => {
          const $tag = renderTagOption(tag);
          $subitemSelect.appendChild($tag);
        });
        return $subitem;
      }
      function renderSubitem(subitem) {
        const $clone = $subitemTemplate.content.cloneNode(true);
        const $subitem = $clone.querySelector(".subitem");
        $subitem.querySelector(".subitem-text").textContent = subitem.text;
        $subitem.querySelector(".subitem-price").textContent = subitem.price;

        const subitemTag = tags.find((tag) => tag.id === subitem.tag);
        $subitem.querySelector(".subitem-tag").textContent =
          subitemTag?.name || "";

        return $subitem;
      }

      function renderTag(tag) {
        const $clone = $tagTemplate.content.cloneNode(true);
        const $tag = $clone.querySelector(".tag");
        $tag.querySelector(".tag-name").textContent = tag.name;
        $tag.querySelector(".tag-remove").onclick = () => {
          const tagItems = items.filter((item) => item.tag === tag.id);
          if (tagItems.length > 0) {
            alert("Тег нельзя удалить");
            console.log({ tagItems });
            return;
          }
          tags = tags.filter((t) => t.id !== tag.id);
          removeTagFromDb(tag);
          $tag.remove();
          updateTagsSelect();
        };
        return $tag;
      }
      function renderTags() {
        tags.forEach((tag) => {
          const $tag = renderTag(tag);
          $tagsList.appendChild($tag);
        });
      }

      function renderTagOption(tag) {
        const $option = document.createElement("option");
        $option.textContent = tag.name;
        $option.value = tag.id;
        return $option;
      }
      function updateTagsSelect() {
        $tagsSelect.innerHTML = "";

        tags.forEach((tag) => {
          const $option = renderTagOption(tag);
          $tagsSelect.appendChild($option);
        });
      }

      function resetNewItemForm() {
        $newItemForm.reset();
        $newItemFormSubitemsList.innerHTML = "";
      }

      // Database
      const dbRequest = indexedDB.open(DB_NAME, DB_VERSION);
      dbRequest.onupgradeneeded = function () {
        let db = dbRequest.result;
        if (!db.objectStoreNames.contains(ITEMS_STORE_NAME)) {
          db.createObjectStore(ITEMS_STORE_NAME, { keyPath: "id" });
        }
        if (!db.objectStoreNames.contains(TAGS_STORE_NAME)) {
          db.createObjectStore(TAGS_STORE_NAME, { keyPath: "id" });
        }
      };
      dbRequest.onerror = function () {
        console.error("DB ERROR", dbRequest.error);
      };
      dbRequest.onsuccess = function () {
        let db = dbRequest.result;
        // Получить записи

        let tagsTransaction = db.transaction(TAGS_STORE_NAME);
        let tagsStore = tagsTransaction.objectStore(TAGS_STORE_NAME);

        const tagsRequest = tagsStore.getAll();
        tagsRequest.onsuccess = function () {
          const result = tagsRequest.result;
          if (result.length > 0) {
            lastTagId = result[result.length - 1].id;
          }

          tags = result;
          renderTags();
          updateTagsSelect();

          let itemsTransaction = db.transaction(ITEMS_STORE_NAME);
          let itemsStore = itemsTransaction.objectStore(ITEMS_STORE_NAME);

          const itemsRequest = itemsStore.getAll();
          itemsRequest.onsuccess = function () {
            const result = itemsRequest.result;
            if (result.length > 0) {
              lastItemId = result[result.length - 1].id;
            }

            items = result;
            renderItems();
          };
        };
      };
      function addItemToDb(item) {
        let db = dbRequest.result;
        let transaction = db.transaction(ITEMS_STORE_NAME, "readwrite");
        let items = transaction.objectStore(ITEMS_STORE_NAME);
        let request = items.add(item);

        request.onsuccess = function () {
          alert("Запись успешно сохранена");
        };

        request.onerror = function () {
          alert("Не удалось сохранить запись");
          console.error(request.error);
        };
      }
      function removeItemFromDb(item) {
        let db = dbRequest.result;
        let transaction = db.transaction(ITEMS_STORE_NAME, "readwrite");
        let items = transaction.objectStore(ITEMS_STORE_NAME);
        let request = items.delete(item.id);

        request.onsuccess = function () {
          alert("Запись успешно удалена");
        };

        request.onerror = function () {
          alert("Не удалось удалить запись");
          console.error(request.error);
        };
      }
      function addTagToDb(tag) {
        let db = dbRequest.result;
        let transaction = db.transaction(TAGS_STORE_NAME, "readwrite");
        let tags = transaction.objectStore(TAGS_STORE_NAME);
        let request = tags.add(tag);

        request.onsuccess = function () {
          alert("Запись успешно сохранена");
        };

        request.onerror = function () {
          alert("Не удалось сохранить запись");
          console.error(request.error);
        };
      }
      function removeTagFromDb(tag) {
        let db = dbRequest.result;
        let transaction = db.transaction(TAGS_STORE_NAME, "readwrite");
        let tags = transaction.objectStore(TAGS_STORE_NAME);
        let request = tags.delete(tag.id);

        request.onsuccess = function () {
          alert("Запись успешно удалена");
        };

        request.onerror = function () {
          alert("Не удалось удалить запись");
          console.error(request.error);
        };
      }

      // DOM
      $newItemForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const fd = new FormData($newItemForm);

        const subitemTexts = fd.getAll("subitems[text][]");
        const subitemPrices = fd.getAll("subitems[price][]");
        const subitemTags = fd.getAll("subitems[tag][]");

        const createdAt = +new Date();

        const newItem = {
          id: ++lastItemId,
          text: fd.get("text"),
          price: fd.get("price"),
          tag: Number(fd.get("tag")),
          createdAt,

          subitems: subitemTexts.map((text, i) => {
            return {
              id: ++lastItemId,
              text,
              price: subitemPrices[i],
              tag: Number(subitemTags[i]),
              createdAt,
            };
          }),
        };
        items.push(newItem);
        const $item = renderItem(newItem);
        $itemsList.appendChild($item);
        addItemToDb(newItem);
        resetNewItemForm();
        $newItemDialog.close();
      });

      $addItemBtn.addEventListener("click", () => {
        $newItemDialog.showModal();
      });

      $closeNewItemDialogBtn.addEventListener("click", () => {
        resetNewItemForm();
        $newItemDialog.close();
      });

      $newTagForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const newTag = {
          id: ++lastTagId,
          name: $newTagForm.elements.name.value,
          createdAt: +new Date(),
        };
        tags.push(newTag);
        const $tag = renderTag(newTag);
        $tagsList.appendChild($tag);
        const $tagOption = renderTagOption(newTag);
        $tagsSelect.appendChild($tagOption);
        addTagToDb(newTag);
        $newTagForm.reset();
        $newTagDialog.close();
      });

      $addTagBtn.addEventListener("click", () => {
        $newTagDialog.showModal();
      });

      $closeNewTagDialogBtn.addEventListener("click", () => {
        $newTagForm.reset();
        $newTagDialog.close();
      });

      $newItemAddSubitemBtn.addEventListener("click", () => {
        const $subitemForm = renderSubitemForm();
        $newItemFormSubitemsList.appendChild($subitemForm);
      });
    </script>
  </body>
</html>
